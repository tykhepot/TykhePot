# TykhePot 项目安全与代码审计报告

**项目名称**: TykhePot (TPOT)
**类型**: Solana 彩票与质押协议
**审计日期**: 2026年2月24日
**总体风险等级**: 中等 (MEDIUM)

---

## 执行摘要

TykhePot 是基于 Solana 区块链的娱乐协议，使用 Anchor/Rust 框架构建。项目架构合理，但在上线主网之前存在若干安全问题和实现缺陷需要修复。

**安全评分**: C+
**代码质量评分**: B-
**架构设计评分**: B
**文档质量评分**: A

---

## 1. 项目概述

### 1.1 核心功能

- **双奖池彩票系统**
  - 小时池：最低 200 TPOT，每小时开奖
  - 日池：最低 100 TPOT，每天 UTC 00:00 开奖
  - 每笔存款：3% 销毁 + 2% 平台费 + 95% 进入奖池

- **质押系统**
  - 30天锁仓：8% 年化收益
  - 180天锁仓：48% 年化收益
  - 提前退出：返还本金，放弃收益

- **空投机制**
  - 每用户免费领取 100 TPOT（锁定状态）
  - 解锁条件：游戏盈利的10倍（上限 10,000 TPOT）

- **推荐奖励**
  - 推荐人：每次推荐获 8% 奖励
  - 被推荐人：首次存款获 2% 一次性奖励

### 1.2 代币分配（总量 10亿 TPOT）

| 用途 | 比例 | 数量 | 归属 |
|------|------|------|------|
| 空投 | 20% | 2亿 | 免费，游戏锁定 |
| 质押奖励 | 25% | 2.5亿 | 质押分发 |
| 推荐奖励 | 20% | 2亿 | 推荐时发放 |
| 游戏储备 | 5% | 5000万 | 奖池流动性 |
| 团队 | 15% | 1.5亿 | 2年线性归属 |
| DEX流动性 | 10% | 1亿 | 配对SOL |
| 生态系统 | 5% | 5000万 | 社区&营销 |

---

## 2. 架构分析

### 2.1 智能合约结构

```
TykhePot Smart Contract
├── lib.rs          - 核心彩票逻辑（存款、开奖、分发）
├── staking.rs      - 质押模块（30天/180天）
├── airdrop.rs      - 空投模块（分发、锁定、解锁）
└── randomness.rs   - 随机数模块（VRF占位符）
```

### 2.2 前端结构

```
React Frontend
├── pages/          - 主要页面（首页、奖池、质押、空投、推荐等）
├── components/     - 复用组件（钱包适配、风险提示等）
├── context/        - 全局状态（AppContext、语言切换）
├── hooks/          - 自定义Hook（useTykhePot, useDemo）
└── utils/          - SDK封装（tykhepot-sdk.js）
```

---

## 3. 智能合约安全分析

### 3.1 安全优点

✅ **整数溢出保护** — 全面使用 `checked_mul`、`checked_div`，中间计算转 u128
✅ **权限控制** — 敏感操作验证 authority，PDA seeds 正确定义
✅ **防重入** — Rust/Anchor 移动语义天然防重入，状态在 CPI 前更新
✅ **重复领取防护** — claimed 标志防止双重领取
✅ **账户验证** — PDA 种子验证、Token Program 权限检查完善
✅ **错误处理** — 清晰的错误码，无用户输入处的 panic!

---

## 4. 发现的问题

### 🔴 严重级别 (CRITICAL) — 0个

无严重安全漏洞。

---

### 🟠 高危级别 (HIGH) — 2个

#### [HIGH-1] 开奖奖励分发逻辑缺失

- **位置**: `lib.rs` — `draw_hourly` / `draw_daily` 函数
- **问题**: 函数接收 `_winning_numbers` 参数但从未使用。函数只重置奖池计数，未执行实际的获奖者筛选和奖金转账。
- **影响**: 用户存款后无法实际获得奖励，核心功能无法运作。
- **问题代码**:
```rust
pub fn draw_hourly(ctx: Context<DrawHourly>, _winning_numbers: WinningNumbers) -> Result<()> {
    // ... 验证 ...
    state.hourly_rollover = rollover;
    state.hourly_pool = 0;
    // ❌ 没有获奖者选择逻辑，没有奖金发放
    Ok(())
}
```
- **修复建议**: 实现完整的获奖者选择算法和奖金分配转账逻辑。

---

#### [HIGH-2] VRF 随机数未实现

- **位置**: `randomness.rs` lines 47-90
- **问题**: 随机数模块使用自定义哈希（`hash_seed`）而非可验证随机函数（VRF），随机数可被预测或操控。
- **影响**: 彩票公平性无法保证，恶意参与者可能预测中奖号码。
- **修复建议**: 集成 Switchboard VRF 或 Pyth Entropy，上线主网前为强制要求。

---

### 🟡 中危级别 (MEDIUM) — 4个

#### [MED-1] 时间戳可被验证者操控

- **位置**: `lib.rs` lines 247-248, 306-307
- **问题**: 使用 `unix_timestamp` 判断开奖时间，Solana 验证者可操控时间戳 ±25 秒（实际影响可达数分钟）。
- **影响**: 开奖时机可被轻微操控，影响公平性。
- **修复建议**:
  - 改为基于 slot 的计时
  - 或将 `TIME_TOLERANCE` 从 60 秒扩大到 300-600 秒
  - 关键操作使用 commit-reveal 模式

---

#### [MED-2] 推荐人参数未验证

- **位置**: `lib.rs` lines 309-310
- **问题**: 仅检查推荐人不等于自己，未验证推荐人是否存在或已参与游戏。
- **影响**: 可引用不活跃或不存在的账户。
- **修复建议**: 维护已注册用户白名单，验证推荐人已参与游戏。

---

#### [MED-3] 推荐奖励不足时静默失败

- **位置**: `lib.rs` lines 350-390
- **问题**: 推荐池不足时不报错，直接跳过支付，用户不会收到承诺的奖励且无任何通知。
- **影响**: 用户体验差，信任损失。
- **修复建议**: 奖励池不足时抛出错误，或发出事件通知。

---

#### [MED-4] 暂停操作无时间锁

- **位置**: `lib.rs` lines 203-215
- **问题**: Authority 可立即暂停合约，无任何延迟机制。
- **影响**: 可突然冻结用户资金，无预警。
- **修复建议**:
  - 暂停操作增加 24-48 小时时间锁
  - 合约暂停时提供紧急提款机制
  - Authority 操作改为多签（multisig）

---

### 🟢 低危级别 (LOW) — 3个

#### [LOW-1] 奖励计算中的 unwrap 风险

- **位置**: `staking.rs` lines 18-21
- **问题**:
```rust
let reward = (amount as u128)
    .checked_mul(apr as u128).unwrap()  // 可能 panic
    .checked_mul(days as u128).unwrap() // 可能 panic
```
- **修复建议**: 将 `unwrap()` 替换为优雅错误处理（`ok_or(ErrorCode::MathOverflow)?`）

---

#### [LOW-2] 奖金未实现线性归属

- **问题**: 白皮书描述奖金应"20天线性释放"，但开奖函数立即全额分发。
- **影响**: 与文档承诺不符。
- **修复建议**: 实现线性归属合约逻辑，让用户按比例领取。

---

#### [LOW-3] 最低参与人数过低

- **问题**: 小时池要求 ≥2 人，日池要求 ≥3 人，参与者极少时彩票结果可预测。
- **修复建议**: 要求最少 10+ 名参与者，否则自动退款。

---

## 5. 前端分析

### 5.1 代码质量

**优点**:
✅ React 组件结构清晰
✅ 使用 Context API 做全局状态管理
✅ 响应式设计，支持移动端
✅ 双语支持（中文/英文）
✅ 钱包适配（Phantom、Solflare）

**缺点**:
- SDK 中 IDL 硬编码且与合约实际接口不匹配
- 多处占位符（如质押方法返回 "Not implemented"）
- 无请求超时处理，网络异常会导致UI挂起
- 无客户端输入验证

### 5.2 前端安全问题

#### [FE-HIGH] IDL 与合约不匹配

- **位置**: `frontend/src/utils/tykhepot-sdk.js`
- **问题**: IDL 硬编码在 JS 文件中，定义了 `emergencyPause` 但合约实际为 `pause`，导致所有合约调用失败。
- **修复**: 使用 `anchor idl init` 生成 IDL，从 JSON 文件加载。

#### [FE-MED] 无请求超时

- **位置**: `useTykhePot.js` 全文
- **问题**: 异步 RPC 调用无超时设置，网络问题导致 UI 永久挂起。
- **修复**: 所有 RPC 调用增加 30 秒超时。

#### [FE-LOW] 缺少客户端输入验证

- **位置**: `HourlyPool.js`
- **问题**: 存款金额仅由合约验证，前端无最小/最大限制提示。
- **修复**: 添加前端验证（最低 200 TPOT，最高限额提示）。

---

## 6. 代币经济分析

### 6.1 风险点

🟡 **48% 年化质押收益过高**
- 需要大量代币储备支撑
- 如流动性下降，可能无法持续
- 可能激励短期套利行为

🟡 **推荐奖励无上限**
- 可快速耗尽储备
- 存在类金字塔结构风险

🟡 **奖池资金可持续性**
- 仅依赖存款的 95%，低参与度时难以维持高额奖励

---

## 7. 测试覆盖率评估

| 模块 | 覆盖率 | 状态 |
|------|--------|------|
| 智能合约 (Rust) | ~40% | ⚠️ 不足，缺少边界情况测试 |
| 前端 (React) | 0% | ❌ 无测试文件 |

**改进建议**:
1. 合约测试覆盖率提升至 80%+
2. 增加模糊测试（fuzz testing）覆盖金额输入
3. 增加并发开奖测试
4. 为前端添加组件单元测试
5. 编写端到端（E2E）测试流程

---

## 8. 修复优先级路线图

### 优先级 1：主网上线前必须修复（阻塞性）

| # | 问题 | 预估工时 |
|---|------|----------|
| 1 | 实现完整开奖逻辑（获奖者选择+奖金发放） | 8-16小时 |
| 2 | 集成 VRF 可验证随机数 | 4-8小时 |
| 3 | 修复前端 IDL 与合约不匹配 | 2-4小时 |

### 优先级 2：强烈建议在主网前完成

| # | 问题 | 预估工时 |
|---|------|----------|
| 4 | 改用基于 slot 的计时或增大容差 | 4-8小时 |
| 5 | 实现暂停操作时间锁 + 紧急提款 | 4-6小时 |
| 6 | 实现奖金20天线性归属 | 6-10小时 |
| 7 | 前端增加请求超时和重试机制 | 2-4小时 |

### 优先级 3：上线后改进

- [ ] 每笔交易设置最高存款限额（如10万TPOT）
- [ ] 提高最低参与人数要求（≥10人）
- [ ] 实现排行榜数据抓取
- [ ] 添加交易历史页面
- [ ] 组织安全审计（Halborn、OtterSec 等Solana专项审计机构）
- [ ] 启动漏洞赏金计划

---

## 9. 主网上线检查清单

- [ ] 所有 HIGH 级问题已修复
- [ ] MEDIUM 级问题已评估并缓解
- [ ] 合约测试覆盖率 ≥ 80%
- [ ] 权威机构安全审计完成
- [ ] Authority 改为多签钱包
- [ ] 紧急暂停和提款流程已记录并测试
- [ ] 主网参数压力测试完成
- [ ] 法律合规审查（目标司法管辖区）
- [ ] 风险披露在显著位置展示
- [ ] 漏洞赏金计划已启动

---

## 10. 总体结论

### 综合评分

| 维度 | 评级 | 说明 |
|------|------|------|
| 安全性 | C+ | 无严重漏洞，但核心功能未完成 |
| 代码质量 | B- | 结构良好，实现不完整 |
| 架构设计 | B | 设计合理，存在执行缺口 |
| 文档质量 | A | 全面详细 |
| 测试覆盖 | D | 严重不足 |

### 当前状态

**❌ 不建议立即上线主网**

当前状态适合：
✅ 继续在 Devnet/Testnet 测试 4-8 周
✅ 安全审计和社区反馈
✅ 漏洞赏金计划

**上线主网条件**：
1. 所有 HIGH 级问题修复完成
2. 完整安全审计通过
3. 测试覆盖率 ≥ 80%
4. 主网参数压力测试完成
5. 法律合规审查通过
6. 紧急程序文档化并测试

### 预估时间线

| 任务 | 时长 |
|------|------|
| 修复 HIGH 级问题 | 2周 |
| 安全审计 | 1周 |
| 测试与验证 | 1周 |
| 法律审查（并行） | 1周 |
| 上线准备 | 1周 |
| **总计** | **4-5周** |

---

*审计完成时间：2026年2月24日*
*下次审查建议：优先级1和2问题修复完成后*
